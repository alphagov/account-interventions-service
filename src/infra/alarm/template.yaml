AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31

Description: >-
  Alarm template for the Account Interventions Service (AIS) solution.

Parameters:
  SystemTagValue:
    Description: Value for the System Tag
    Type: String
    Default: Account Interventions Service
  AlertingSNSLowAlertNotificationTopicARN:
    Description: "The ARN of the Alerting SNS Low Alert Notification topic"
    Type: AWS::SSM::Parameter::Value<String>
    Default: "/ais-infra-alerting/SNS/LowAlertNotificationTopic/ARN" #pragma: allowlist secret
  AlertingSNSHighAlertNotificationTopicARN:
    Description: "The ARN of the Alerting SNS High Alert Notification topic"
    Type: AWS::SSM::Parameter::Value<String>
    Default: "/ais-infra-alerting/SNS/HighAlertNotificationTopic/ARN" #pragma: allowlist secret
  TxMAEgressQueueName:
    Description: "The name of the TxMA Egress queue"
    Type: AWS::SSM::Parameter::Value<String>
    Default: "/ais-main/SQS/TxMAEgressQueue/Name" #pragma: allowlist secret
  TxMAEgressDLQName:
    Description: "The name of the TxMA Egress DLQ"
    Type: AWS::SSM::Parameter::Value<String>
    Default: "/ais-main/SQS/TxMAEgressDLQ/Name" #pragma: allowlist secret
  PrivateRestApiName:
    Description: "The name of the Private API Gateway"
    Type: AWS::SSM::Parameter::Value<String>
    Default: "/ais-main/PrivateRestApi/Name"
  RunBookURL:
    Description: "A Link to the AIS Runbook"
    Type: String
    Default: "https://govukverify.atlassian.net/wiki/spaces/AB/pages/3892215824/Alarms+Metrics+Monitoring"

Resources:
#
# CloudWatch Alarms for SQS Queues
#

  TxMAEgressQueueProcessingSlowly:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "TxMA Egress queue processing slowly. ${RunBookURL}"
      ComparisonOperator: GreaterThanThreshold
      Threshold: 60
      EvaluationPeriods: 1
      TreatMissingData: notBreaching
      Dimensions:
        - Name: QueueName
          Value: !Ref TxMAEgressQueueName
      MetricName: ApproximateAgeOfOldestMessage
      Namespace: AWS/SQS
      Period: 60
      Statistic: Maximum

  TxMAEgressQueueProcessingTooSlow:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "TxMA Egress queue processing too slow. ${RunBookURL}"
      ComparisonOperator: GreaterThanThreshold
      Threshold: 600
      EvaluationPeriods: 1
      TreatMissingData: notBreaching
      Dimensions:
        - Name: QueueName
          Value: !Ref TxMAEgressQueueName
      MetricName: ApproximateAgeOfOldestMessage
      Namespace: AWS/SQS
      Period: 60
      Statistic: Maximum

  TxMAEgressQueueHasBacklog:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "TxMA Egress queue has backlog. ${RunBookURL}"
      ComparisonOperator: GreaterThanThreshold
      Threshold: 10
      EvaluationPeriods: 1
      TreatMissingData: notBreaching
      Dimensions:
        - Name: QueueName
          Value: !Ref TxMAEgressQueueName
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Period: 60
      Statistic: Maximum

  TxMAEgressQueueTooManyMessages:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "TxMA Egress queue has too many messages. ${RunBookURL}"
      ComparisonOperator: GreaterThanThreshold
      Threshold: 50
      EvaluationPeriods: 1
      TreatMissingData: notBreaching
      Dimensions:
        - Name: QueueName
          Value: !Ref TxMAEgressQueueName
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Period: 60
      Statistic: Maximum

  TxMAEgressDLQHasMessages:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "TxMA Egress DLQ has messages. ${RunBookURL}"
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Threshold: 1
      EvaluationPeriods: 1
      TreatMissingData: notBreaching
      Dimensions:
        - Name: QueueName
          Value: !Ref TxMAEgressDLQName
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Period: 60
      Statistic: Maximum

  TxMAEgressDLQTooManyMessages:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "TxMA Egress DLQ has too many messages. ${RunBookURL}"
      ComparisonOperator: GreaterThanThreshold
      Threshold: 10
      EvaluationPeriods: 1
      TreatMissingData: notBreaching
      Dimensions:
        - Name: QueueName
          Value: !Ref TxMAEgressDLQName
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Period: 60
      Statistic: Maximum

#
# CloudWatch Alarms for Updating Deletion Status
#

  AISUpdateDeleteFailed:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "User's deletion status failed to be updated. ${RunBookURL}"
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Threshold: 1
      EvaluationPeriods: 1
      TreatMissingData: notBreaching
      MetricName: MARK_AS_DELETED_FAILED
      Namespace: !Ref SystemTagValue
      Dimensions:
        - Name: service
          Value: AccountDeletionProcessorFunction
      Period: 60
      Statistic: Sum
      Unit: Count

  AISUpdateDeleteDDBError:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "User's deletion status failed to be updated due to DynamoDB. ${RunBookURL}"
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Threshold: 1
      EvaluationPeriods: 1
      TreatMissingData: notBreaching
      MetricName: DB_UPDATE_ERROR
      Namespace: !Ref SystemTagValue
      Dimensions:
        - Name: service
          Value: AccountDeletionProcessorFunction
      Period: 60
      Statistic: Sum
      Unit: Count

#
# CloudWatch alarms for State Engine
#

  AccountStateEngineConfigurationIssue:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSHighAlertNotificationTopicARN
      AlarmDescription: !Sub "There is a configuration issue with the Account State Engine. ${RunBookURL}"
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Threshold: 1
      EvaluationPeriods: 1
      TreatMissingData: notBreaching
      Metrics:
        - Id: m1
          Label: "configuration file failed validation"
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: !Ref SystemTagValue
              MetricName: INVALID_STATE_ENGINE_CONFIGURATION
              Dimensions:
                - Name: service
                  Value: InterventionsProcessorFunction
            Period: 60
            Stat: Sum
        - Id: m2
          Label: "The applied intervention resulted in no state changes."
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: !Ref SystemTagValue
              MetricName: TRANSITION_SAME_AS_CURRENT_STATE
              Dimensions:
                - Name: service
                  Value: InterventionsProcessorFunction
            Period: 60
            Stat: Sum
        - Id: m3
          Label: "The user's state could not be found in current config file."
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: !Ref SystemTagValue
              MetricName: STATE_NOT_FOUND_IN_CURRENT_CONFIG
              Dimensions:
                - Name: service
                  Value: InterventionsProcessorFunction
            Period: 60
            Stat: Sum
        - Id: m4
          Label: "The current account state has no transitions in current config file."
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: !Ref SystemTagValue
              MetricName: NO_TRANSITIONS_FOUND_IN_CONFIG
              Dimensions:
                - Name: service
                  Value: InterventionsProcessorFunction
            Period: 60
            Stat: Sum
        - Id: m5
          Label: "The intervention did not have an intervention name field in current config."
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: !Ref SystemTagValue
              MetricName: INTERVENTION_DID_NOT_HAVE_NAME_IN_CURRENT_CONFIG
              Dimensions:
                - Name: service
                  Value: InterventionsProcessorFunction
            Period: 60
            Stat: Sum
        - Id: sum_of_occurrences
          Label: 'total number of configuration issues'
          ReturnData: true
          Expression: SUM([m1,m2,m3,m4,m5])

  InterventionCodeNotFound:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "Intervention Event was received with unknown Intervention code. ${RunBookURL}"
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Threshold: 1
      EvaluationPeriods: 1
      TreatMissingData: notBreaching
      MetricName: INTERVENTION_CODE_NOT_FOUND_IN_CONFIG
      Namespace: !Ref SystemTagValue
      Dimensions:
        - Name: service
          Value: InterventionsProcessorFunction
      Period: 60
      Statistic: Sum
      Unit: Count

  InterventionNotAllowed:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "Intervention received was not allowed on current account state. ${RunBookURL}"
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Threshold: 5
      EvaluationPeriods: 1
      TreatMissingData: notBreaching
      MetricName: STATE_TRANSITION_NOT_ALLOWED_OR_IGNORED
      Namespace: !Ref SystemTagValue
      Dimensions:
        - Name: service
          Value: InterventionsProcessorFunction
      Period: 120
      Statistic: Sum
      Unit: Count

  TooManyInterventionNotAllowed:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "Too many Interventions received were not allowed on current account state. ${RunBookURL}"
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Threshold: 5
      EvaluationPeriods: 5
      TreatMissingData: notBreaching
      MetricName: STATE_TRANSITION_NOT_ALLOWED_OR_IGNORED
      Namespace: !Ref SystemTagValue
      Dimensions:
        - Name: service
          Value: InterventionsProcessorFunction
      Period: 60
      Statistic: Sum
      Unit: Count

#
# CloudWatch alarms for Account Interventions Processor
#

  InvalidEventReceived:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "Received intervention event is invalid. ${RunBookURL}"
      Namespace: !Ref SystemTagValue
      MetricName: INVALID_EVENT_RECEIVED
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Statistic: Sum
      Threshold: 5
      EvaluationPeriods: 1
      Period: 60
      TreatMissingData: notBreaching
      Dimensions:
        - Name: service
          Value: InterventionsProcessorFunction

  TooManyInvalidEventsReceived:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "Too many received intervention events are invalid. ${RunBookURL}"
      Namespace: !Ref SystemTagValue
      MetricName: INVALID_EVENT_RECEIVED
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Statistic: Sum
      Threshold: 5
      EvaluationPeriods: 5
      Period: 60
      TreatMissingData: notBreaching
      Dimensions:
        - Name: service
          Value: InterventionsProcessorFunction

  AccountMarkedAsDeleted:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "Intervention event failed validation. ${RunBookURL}"
      Namespace: !Ref SystemTagValue
      MetricName: ACCOUNT_IS_MARKED_AS_DELETED
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Statistic: Sum
      Threshold: 5
      EvaluationPeriods: 1
      Period: 60
      TreatMissingData: notBreaching
      Dimensions:
        - Name: service
          Value: InterventionsProcessorFunction

  InterventionIgnoredInFuture:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "Intervention event has timestamp in future. ${RunBookURL}"
      Namespace: !Ref SystemTagValue
      MetricName: INTERVENTION_IGNORED_IN_FUTURE
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Statistic: Sum
      Threshold: 5
      EvaluationPeriods: 1
      Period: 60
      TreatMissingData: notBreaching
      Dimensions:
        - Name: service
          Value: InterventionsProcessorFunction

  LevelOfConfidenceTooLow:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "Level of confidence is too low. ${RunBookURL}"
      Namespace: !Ref SystemTagValue
      MetricName: CONFIDENCE_LEVEL_TOO_LOW
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Statistic: Sum
      Threshold: 5
      EvaluationPeriods: 1
      Period: 60
      TreatMissingData: notBreaching
      Dimensions:
        - Name: service
          Value: InterventionsProcessorFunction

  InterventionEventStale:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "Intervention event messages are out of order. ${RunBookURL}"
      Namespace: !Ref SystemTagValue
      MetricName: INTERVENTION_EVENT_STALE
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Statistic: Sum
      Threshold: 5
      EvaluationPeriods: 1
      Period: 60
      TreatMissingData: notBreaching
      Dimensions:
        - Name: service
          Value: InterventionsProcessorFunction

  TooManyInterventionEventStale:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "Too many intervention event messages are out of order. ${RunBookURL}"
      Namespace: !Ref SystemTagValue
      MetricName: INTERVENTION_EVENT_STALE
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Statistic: Sum
      Threshold: 5
      EvaluationPeriods: 5
      Period: 60
      TreatMissingData: notBreaching
      Dimensions:
        - Name: service
          Value: InterventionsProcessorFunction

  DBQueryNoResponseErrorInterventionsProcessor:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "DynamoDB query no response error relating to InterventionsProcessorFunction. ${RunBookURL}"
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Threshold: 1
      EvaluationPeriods: 1
      TreatMissingData: notBreaching
      MetricName: DB_QUERY_ERROR_NO_RESPONSE
      Namespace: !Ref SystemTagValue
      Dimensions:
        - Name: service
          Value: InterventionsProcessorFunction
      Period: 60
      Statistic: Sum
      Unit: Count

  DBQueryNoResponseErrorStatusRetriever:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "DynamoDB query no response error relating to StatusRetrieverFunction. ${RunBookURL}"
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Threshold: 1
      EvaluationPeriods: 1
      TreatMissingData: notBreaching
      MetricName: DB_QUERY_ERROR_NO_RESPONSE
      Namespace: !Ref SystemTagValue
      Dimensions:
        - Name: service
          Value: StatusRetrieverFunction
      Period: 60
      Statistic: Sum
      Unit: Count

  TooManyDBQueryNoResponseError:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSHighAlertNotificationTopicARN
      AlarmDescription: !Sub "The query to DynamoDB has provided the no response error twice within a minute. ${RunBookURL}"
      ComparisonOperator: GreaterThanOrEqualToThreshold
      DatapointsToAlarm: 1
      Threshold: 2
      EvaluationPeriods: 1
      TreatMissingData: notBreaching
      MetricName: DB_QUERY_ERROR_NO_RESPONSE
      Namespace: !Ref SystemTagValue
      Dimensions:
        - Name: service
          Value: InterventionsProcessorFunction
      Period: 60
      Statistic: Sum
      Unit: Count

  DBQueryTooManyItemsError:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "DynamoDB query returned too many items. ${RunBookURL}"
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Threshold: 1
      EvaluationPeriods: 1
      TreatMissingData: notBreaching
      MetricName: DB_QUERY_ERROR_TOO_MANY_ITEMS
      Namespace: !Ref SystemTagValue
      Dimensions:
        - Name: service
          Value: InterventionsProcessorFunction
      Period: 60
      Statistic: Sum
      Unit: Count

  TooManyDBQueryTooManyItemsError:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSHighAlertNotificationTopicARN
      AlarmDescription: !Sub "DynamoDB query too many items error once within a minute. ${RunBookURL}"
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Threshold: 1
      EvaluationPeriods: 1
      TreatMissingData: notBreaching
      MetricName: DB_QUERY_ERROR_TOO_MANY_ITEMS
      Namespace: !Ref SystemTagValue
      Dimensions:
        - Name: service
          Value: InterventionsProcessorFunction
      Period: 60
      Statistic: Sum
      Unit: Count

  TxMAPublishFailed:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "Publishing to TxMA failed. ${RunBookURL}"
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Threshold: 1
      EvaluationPeriods: 1
      TreatMissingData: notBreaching
      MetricName: ERROR_PUBLISHING_EVENT_TO_TXMA
      Namespace: !Ref SystemTagValue
      Dimensions:
        - Name: service
          Value: InterventionsProcessorFunction
      Period: 60
      Statistic: SampleCount
      Unit: Count

  TxMAPublishFailures:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSHighAlertNotificationTopicARN
      AlarmDescription: !Sub "Publishing to TxMA failed once every minute for two periods over a span of 10 minutes. ${RunBookURL}"
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Threshold: 1
      EvaluationPeriods: 10
      DatapointsToAlarm: 2
      TreatMissingData: notBreaching
      MetricName: ERROR_PUBLISHING_EVENT_TO_TXMA
      Namespace: !Ref SystemTagValue
      Dimensions:
        - Name: service
          Value: InterventionsProcessorFunction
      Period: 60
      Statistic: SampleCount
      Unit: Count

  InvalidSchema:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSHighAlertNotificationTopicARN
      AlarmDescription: !Sub "Schema is invalid. ${RunBookURL}"
      Namespace: !Ref SystemTagValue
      MetricName: INVALID_SCHEMA
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Statistic: Sum
      Threshold: 1
      EvaluationPeriods: 1
      Period: 60
      TreatMissingData: notBreaching
      Dimensions:
        - Name: service
          Value: InterventionsProcessorFunction

#
# CloudWatch alarms for TxMA Latency
#

  AverageTxMALatencyOver2Sec:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "Messages from TxMA have an average latency above 2s.${RunBookURL}"
      Namespace: !Ref SystemTagValue
      MetricName: EVENT_DELIVERY_LATENCY
      ComparisonOperator: GreaterThanThreshold
      Statistic: Average
      Threshold: 2000
      EvaluationPeriods: 1
      Period: 60
      TreatMissingData: notBreaching
      Dimensions:
        - Name: service
          Value: InterventionsProcessorFunction

  AverageTxMALatencyOver5Sec:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "Messages from TxMA have an average latency above 5s. ${RunBookURL}"
      Namespace: !Ref SystemTagValue
      MetricName: EVENT_DELIVERY_LATENCY
      ComparisonOperator: GreaterThanThreshold
      Statistic: Average
      Threshold: 5000
      EvaluationPeriods: 1
      Period: 60
      TreatMissingData: notBreaching
      Dimensions:
        - Name: service
          Value: InterventionsProcessorFunction

  MaxTxMALatencyOver10Sec:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "Messages from TxMA have a maximum latency above 10s. ${RunBookURL}"
      Namespace: !Ref SystemTagValue
      MetricName: EVENT_DELIVERY_LATENCY
      ComparisonOperator: GreaterThanThreshold
      Statistic: Average
      Threshold: 10000
      EvaluationPeriods: 1
      Period: 60
      TreatMissingData: notBreaching
      Dimensions:
        - Name: service
          Value: InterventionsProcessorFunction

#
# CloudWatch alarms for Status Retriever
#

  DbQueryError:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSHighAlertNotificationTopicARN
      AlarmDescription: !Sub "An error occurred with the query to DynamoDB once every minutes for two consecutive periods. ${RunBookURL}"
      Namespace: !Ref SystemTagValue
      MetricName: DB_QUERY_ERROR
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Statistic: Sum
      Threshold: 1
      EvaluationPeriods: 2
      Period: 60
      TreatMissingData: notBreaching
      Dimensions:
        - Name: service
          Value: StatusRetrieverFunction

  InvalidSubjectId:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "User ID was not found in the event once every minute for three periods over 10 minutes. ${RunBookURL}"
      Namespace: !Ref SystemTagValue
      MetricName: INVALID_SUBJECT_ID
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Statistic: Sum
      Threshold: 1
      EvaluationPeriods: 10
      DatapointsToAlarm: 3
      Period: 60
      TreatMissingData: notBreaching
      Dimensions:
        - Name: service
          Value: StatusRetrieverFunction

  InvalidHistoryString:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "History string may be missing required components. ${RunBookURL}"
      Namespace: !Ref SystemTagValue
      MetricName: INVALID_HISTORY_STRING
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Statistic: Sum
      Threshold: 1
      EvaluationPeriods: 5
      Period: 60
      TreatMissingData: notBreaching
      Dimensions:
        - Name: service
          Value: StatusRetrieverFunction

#
# CloudWatch alarms for API Gateway
#

  ApiLatencyP95Taking2SecsOrLonger:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "Over 5% of API Gateway requests are exceeding 2 seconds in a 10 minute period. ${RunBookURL}"
      Namespace: AWS/ApiGateway
      MetricName: Latency
      ComparisonOperator: GreaterThanThreshold
      ExtendedStatistic: p95
      Threshold: 2000
      EvaluationPeriods: 1
      Period: 600
      TreatMissingData: notBreaching
      Dimensions:
        - Name: ApiName
          Value: !Ref PrivateRestApiName

  ApiLatencyP80Taking2SecsOrLonger:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "Over 20% of API Gateway requests are exceeding 2 seconds in a 10 minute period. ${RunBookURL}"
      Namespace: AWS/ApiGateway
      MetricName: Latency
      ComparisonOperator: GreaterThanThreshold
      ExtendedStatistic: p80
      Threshold: 2000
      EvaluationPeriods: 1
      Period: 600
      TreatMissingData: notBreaching
      Dimensions:
        - Name: ApiName
          Value: !Ref PrivateRestApiName

  ApiHttp5xxErrors:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "Small proportion of 5XX errors on the API Gateway. ${RunBookURL}"
      Threshold: 1
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<1,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Ref PrivateRestApiName
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: ApiName
                  Value: !Ref PrivateRestApiName
            Period: 60
            Stat: Sum

  ApiHttp5xxCriticalErrors:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSHighAlertNotificationTopicARN
      AlarmDescription: !Sub "Significant proportion of 5XX errors on the API Gateway. ${RunBookURL}"
      Threshold: 80
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<1,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Ref PrivateRestApiName
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: ApiName
                  Value: !Ref PrivateRestApiName
            Period: 60
            Stat: Sum

  ApiHttp4xxErrors:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertingSNSLowAlertNotificationTopicARN
      AlarmDescription: !Sub "Small proportion of 4XX errors on the API Gateway. ${RunBookURL}"
      Threshold: 1
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<1,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Ref PrivateRestApiName
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 4XXError
              Dimensions:
                - Name: ApiName
                  Value: !Ref PrivateRestApiName
            Period: 60
            Stat: Sum
