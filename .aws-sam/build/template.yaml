AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Main template for the account interventions service solution
Parameters:
  Environment:
    Description: The name of the environment to deploy to
    Type: String
    AllowedValues:
    - dev
    - build
    - staging
    - integration
    - production
    Default: dev
  ApiStageName:
    Description: The stage name of the API
    Type: String
    Default: v1
  VpcStackName:
    Description: The name of the stack that defines the VPC
    Type: String
    Default: vpc
    AllowedPattern: ^[a-z0-9-]+$
    ConstraintDescription: must be a valid organization ID, made of lowercase letters
      and numbers
  PermissionsBoundary:
    Description: The ARN of the permissions boundary to apply when creating IAM roles
    Type: String
    Default: none
  CoreStackName:
    Description: The name of the Core VC Storage stack
    Type: String
    Default: account-interventions-service-core
  ProductTagValue:
    Description: Value for the Product Tag
    Type: String
    Default: GOV.UK One Login
  SystemTagValue:
    Description: Value for the System Tag
    Type: String
    Default: Account Interventions Service
  OwnerTagValue:
    Description: Value for the Owner Tag
    Type: String
    Default: PLACEHOLDER
  SourceTagValue:
    Description: Value for the Source Tag
    Type: String
    Default: govuk-one-login/account-interventions-service/src/infra/main/template.yaml
Conditions:
  UsePermissionsBoundary:
    Fn::Not:
    - Fn::Equals:
      - Ref: PermissionsBoundary
      - none
Mappings:
  EnvConfig:
    dev:
      LambdaLogLevel: DEBUG
      OrchestrationVPCID: vpc-093ac0375aa3f291d
      AuthenticationVPCID: vpc-093ac0375aa3f291d
      OneLoginHomeVPCID: vpc-093ac0375aa3f291d
    build:
      LambdaLogLevel: INFO
      OrchestrationVPCID: vpc-0ae068c236590b989
      AuthenticationVPCID: vpc-0ae068c236590b989
      OneLoginHomeVPCID: vpc-0ae068c236590b989
    staging:
      LambdaLogLevel: INFO
      OrchestrationVPCID: vpc-09cfe19dc5f8fcb47
      AuthenticationVPCID: vpc-09cfe19dc5f8fcb47
      OneLoginHomeVPCID: vpc-09cfe19dc5f8fcb47
    integration:
      LambdaLogLevel: INFO
      OrchestrationVPCID: vpc-0ae72461a035c0934
      AuthenticationVPCID: vpc-0ae72461a035c0934
      OneLoginHomeVPCID: vpc-0ae72461a035c0934
    production:
      LambdaLogLevel: INFO
      OrchestrationVPCID: vpc-0744a49090620ce26
      AuthenticationVPCID: vpc-0744a49090620ce26
      OneLoginHomeVPCID: vpc-0744a49090620ce26
Globals:
  Function:
    Runtime: nodejs18.x
    Architectures:
    - arm64
    Tracing: Active
    AutoPublishAlias: latest
    Environment:
      Variables:
        LOG_LEVEL:
          Fn::FindInMap:
          - EnvConfig
          - Ref: Environment
          - LambdaLogLevel
        POWERTOOLS_SERVICE_NAME:
          Ref: AWS::StackName
        CLOUDWATCH_METRICS_NAMESPACE:
          Ref: SystemTagValue
    VpcConfig:
      SubnetIds:
      - Fn::ImportValue:
          Fn::Sub: ${VpcStackName}-ProtectedSubnetIdA
      - Fn::ImportValue:
          Fn::Sub: ${VpcStackName}-ProtectedSubnetIdB
      - Fn::ImportValue:
          Fn::Sub: ${VpcStackName}-ProtectedSubnetIdC
      SecurityGroupIds:
      - Fn::ImportValue:
          Fn::Sub: ${VpcStackName}-AWSServicesEndpointSecurityGroupId
Resources:
  AISSampleLambdaFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${AWS::StackName}-InterventionHistoryWriterFunction
      CodeUri: AISSampleLambdaFunction
      Timeout: 10
      Environment:
        Variables:
          TABLE_NAME:
            Fn::ImportValue:
              Fn::Sub: ${CoreStackName}-AccountStatusTableName
          METRIC_SERVICE_NAME:
            Fn::Sub: ${AWS::StackName}-SampleLambda
      Handler: sample-lambda-handler.handle
      Role:
        Fn::GetAtt:
        - AISSampleLambdaHandlerRole
        - Arn
      Tags:
        CheckovRulesToSkip: CKV_AWS_116.CKV_AWS_115
        Product:
          Ref: ProductTagValue
        System:
          Ref: SystemTagValue
        Environment:
          Ref: Environment
        Owner:
          Ref: OwnerTagValue
        Source:
          Ref: SourceTagValue
    Metadata:
      SamResourceId: AISSampleLambdaFunction
  AISSampleLambdaHandlerRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName:
        Fn::Sub: ${AWS::StackName}-AISSampleLambdaHandlerRole
      PermissionsBoundary:
        Fn::If:
        - UsePermissionsBoundary
        - Ref: PermissionsBoundary
        - Ref: AWS::NoValue
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action:
          - sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
      - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Tags:
      - Key: Product
        Value:
          Ref: ProductTagValue
      - Key: System
        Value:
          Ref: SystemTagValue
      - Key: Environment
        Value:
          Ref: Environment
      - Key: Owner
        Value:
          Ref: OwnerTagValue
      - Key: Source
        Value:
          Ref: SourceTagValue
  AISSampleLambdaHandlerPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName:
        Fn::Sub: ${AWS::StackName}-AISSampleLambdaHandlerPolicy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - dynamodb:PutItem
          Resource:
          - Fn::ImportValue:
              Fn::Sub: ${CoreStackName}-AccountStatusTableArn
      Roles:
      - Ref: AISSampleLambdaHandlerRole
  SQSEncryptionKey:
    Type: AWS::KMS::Key
    Properties:
      Description: AWS KMS key for encrypting the contents of messages in TxMA SQS
        queues
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            AWS:
              Fn::Sub: arn:aws:iam::${AWS::AccountId}:root
          Action: kms:*
          Resource:
          - '*'
        - Effect: Allow
          Principal:
            Service: sqs.amazonaws.com
          Action:
          - kms:Decrypt
          - kms:GenerateDataKey
          Resource: '*'
          Condition:
            ArnLike:
              aws:SourceArn:
                Fn::Sub: arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:*
      Tags:
      - Key: Product
        Value:
          Ref: ProductTagValue
      - Key: System
        Value:
          Ref: SystemTagValue
      - Key: Environment
        Value:
          Ref: Environment
      - Key: Owner
        Value:
          Ref: OwnerTagValue
      - Key: Source
        Value:
          Ref: SourceTagValue
      - Key: Name
        Value:
          Fn::Sub: ${AWS::StackName}-SQSEncryptionKey
  SQSEncryptionKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName:
        Fn::Sub: alias/${AWS::StackName}-SQSEncryptionKey
      TargetKeyId:
        Fn::GetAtt:
        - SQSEncryptionKey
        - Arn
  TxMAIngressQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: ${AWS::StackName}-TxMAIngressQueue
      MessageRetentionPeriod: 1209600
      KmsMasterKeyId:
        Fn::GetAtt:
        - SQSEncryptionKey
        - Arn
      RedriveAllowPolicy:
        redrivePermission: denyAll
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - TxMAIngressDLQ
          - Arn
        maxReceiveCount: 3
      VisibilityTimeout: 60
      Tags:
      - Key: Product
        Value:
          Ref: ProductTagValue
      - Key: System
        Value:
          Ref: SystemTagValue
      - Key: Environment
        Value:
          Ref: Environment
      - Key: Owner
        Value:
          Ref: OwnerTagValue
      - Key: Source
        Value:
          Ref: SourceTagValue
  TxMAIngressQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    DependsOn: TxMAIngressQueue
    Properties:
      Queues:
      - Ref: TxMAIngressQueue
      PolicyDocument:
        Statement:
        - Effect: Allow
          Action:
          - sqs:SendMessage
          Resource:
            Fn::GetAtt:
            - TxMAIngressQueue
            - Arn
          Principal:
            Service: sns.amazonaws.com
  TxMAIngressDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: ${AWS::StackName}-TxMAIngressDLQ
      KmsMasterKeyId:
        Ref: SQSEncryptionKeyAlias
      VisibilityTimeout: 0
      MessageRetentionPeriod: 1209600
      RedriveAllowPolicy:
        redrivePermission: byQueue
        sourceQueueArns:
        - Fn::Sub: arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:${AWS::StackName}-TxMAIngressQueue
      Tags:
      - Key: Product
        Value:
          Ref: ProductTagValue
      - Key: System
        Value:
          Ref: SystemTagValue
      - Key: Environment
        Value:
          Ref: Environment
      - Key: Owner
        Value:
          Ref: OwnerTagValue
      - Key: Source
        Value:
          Ref: SourceTagValue
  StatusRetrieverFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${AWS::StackName}-StatusRetrieverFunction
      CodeUri: StatusRetrieverFunction
      Timeout: 10
      Environment:
        Variables:
          TABLE_NAME:
            Fn::ImportValue:
              Fn::Sub: ${CoreStackName}-AccountStatusTableName
          METRIC_SERVICE_NAME:
            Fn::Sub: ${AWS::StackName}-StatusRetriever
      Handler: status-retriever-handler.handle
      Role:
        Fn::GetAtt:
        - StatusRetrieverFunctionRole
        - Arn
      Tags:
        CheckovRulesToSkip: CKV_AWS_116.CKV_AWS_115
        Product:
          Ref: ProductTagValue
        System:
          Ref: SystemTagValue
        Environment:
          Ref: Environment
        Owner:
          Ref: OwnerTagValue
        Source:
          Ref: SourceTagValue
    Metadata:
      SamResourceId: StatusRetrieverFunction
  StatusRetrieverFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName:
        Fn::Sub: ${AWS::StackName}-StatusRetrieverFunctionRole
      PermissionsBoundary:
        Fn::If:
        - UsePermissionsBoundary
        - Ref: PermissionsBoundary
        - Ref: AWS::NoValue
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action:
          - sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
      - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Tags:
      - Key: Product
        Value:
          Ref: ProductTagValue
      - Key: System
        Value:
          Ref: SystemTagValue
      - Key: Environment
        Value:
          Ref: Environment
      - Key: Owner
        Value:
          Ref: OwnerTagValue
      - Key: Source
        Value:
          Ref: SourceTagValue
  StatusRetrieverFunctionPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName:
        Fn::Sub: ${AWS::StackName}-StatusRetrieverFunctionPolicy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - dynamodb:Query
          - dynamodb:GetItem
          Resource:
          - Fn::ImportValue:
              Fn::Sub: ${CoreStackName}-AccountStatusTableArn
      Roles:
      - Ref: StatusRetrieverFunctionRole
  PrivateRestApi:
    Type: AWS::Serverless::Api
    Properties:
      Name:
        Fn::Sub: ${AWS::StackName}-PrivateRestApi
      AlwaysDeploy: true
      OpenApiVersion: 3.0.3
      DefinitionBody:
        Fn::Transform:
          Name: AWS::Include
          Parameters:
            Location: ../../src/specs/api.yaml
      Description: Private REST API that provides method to interact with the account
        interventions services
      StageName:
        Ref: ApiStageName
      Auth:
        ResourcePolicy:
          IntrinsicVpcWhitelist:
          - Fn::FindInMap:
            - EnvConfig
            - Ref: Environment
            - AuthenticationVPCID
          - Fn::FindInMap:
            - EnvConfig
            - Ref: Environment
            - OneLoginHomeVPCID
          - Fn::FindInMap:
            - EnvConfig
            - Ref: Environment
            - OrchestrationVPCID
      CacheClusterEnabled: false
      TracingEnabled: true
      EndpointConfiguration:
        Type: PRIVATE
      Tags:
        CheckovRulesToSkip: CKV_AWS_120
        Product:
          Ref: ProductTagValue
        System:
          Ref: SystemTagValue
        Environment:
          Ref: Environment
        Owner:
          Ref: OwnerTagValue
        Source:
          Ref: SourceTagValue
  PrivateGatewayStatusRetrieverFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Ref: StatusRetrieverFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceAccount:
        Ref: AWS::AccountId
      SourceArn:
        Fn::Sub: arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${PrivateRestApi}/*/*
